<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astro Stack (Layer Aligner)</title>

  <style>
    :root { --bg:#0b1020; --panel:#111a33; --muted:#9fb2ff; --text:#e8ecff; --accent:#6aa9ff; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 30% 10%, #16224a 0%, var(--bg) 60%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    header {
      padding: 14px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(8,12,26,.6);
      backdrop-filter: blur(8px);
    }

    header h1 {
      font-size: 14px;
      letter-spacing: .6px;
      text-transform: uppercase;
      margin: 0;
      color: #cfe0ff;
    }

    .wrap {
      display: grid;
      grid-template-columns: 360px 1fr;
      height: calc(100vh - 52px);
    }

    .panel {
      background: linear-gradient(180deg, rgba(17,26,51,.9), rgba(12,18,35,.95));
      border-right: 1px solid rgba(255,255,255,.08);
      overflow: auto;
      padding: 14px;
      -webkit-overflow-scrolling: touch;
    }

    .panel .block {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .muted { color: rgba(232,236,255,.75); font-size: 12px; }

    .btn {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }

    .btn.primary {
      background: rgba(106,169,255,.14);
      border-color: rgba(106,169,255,.5);
    }

    input[type="file"] { display:none; }

    .stage {
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(900px 500px at 50% 40%, rgba(140,190,255,.10), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
    }

    canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .hud {
      position: absolute;
      left: 14px;
      bottom: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,12,26,.55);
      backdrop-filter: blur(8px);
      font-size: 12px;
      max-width: min(560px, 90%);
    }

    .layer {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
      margin-top: 10px;
    }

    .layer.active {
      border-color: rgba(106,169,255,.65);
      box-shadow: 0 0 0 3px rgba(106,169,255,.10);
    }

    .layer-title {
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ctl {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    select, input[type="range"], input[type="number"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 8px;
    }

    /* =========================
       RESPONSIVE (ANDROID)
       ========================= */
    @media (max-width: 900px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .wrap {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }

      .stage {
        min-height: 55vh;
        order: 1;
      }

      .panel {
        order: 2;
        max-height: 45vh;
        border-right: none;
        border-top: 1px solid rgba(255,255,255,.08);
      }

      .hud {
        left: 8px;
        right: 8px;
        bottom: 8px;
        font-size: 11px;
      }

      .btn {
        padding: 12px 14px;
        font-size: 13px;
      }

      select,
      input[type="range"],
      input[type="number"] {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
<header>
  <h1>Astro Stack â€” Layer Aligner</h1>
  <div class="muted">Load frames, align, blend, export.</div>
</header>

<div class="wrap">
  <aside class="panel">
    <div class="block">
      <div class="row">
        <label class="btn primary" for="fileInput">Load Images</label>
        <input id="fileInput" type="file" accept="image/*" multiple />
        <button class="btn" id="fitBtn">Fit</button>
        <button class="btn" id="resetViewBtn">Reset</button>
        <button class="btn" id="exportBtn">Export PNG</button>
      </div>
    </div>

    <div class="block">
      <div id="layers"></div>
    </div>
  </aside>

  <main class="stage" id="stage">
    <canvas id="c"></canvas>
    <div class="hud" id="hud">No images loaded</div>
  </main>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const stage = document.getElementById("stage");
  const fileInput = document.getElementById("fileInput");
  const layersEl = document.getElementById("layers");
  const hud = document.getElementById("hud");

  let layers = [];
  let view = { x: 0, y: 0, z: 1 };

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = stage.clientWidth * dpr;
    canvas.height = stage.clientHeight * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    draw();
  }
  window.addEventListener("resize", resize);
  resize();

  function draw() {
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.translate(view.x, view.y);
    ctx.scale(view.z, view.z);

    layers.forEach(l => {
      ctx.globalAlpha = l.o;
      ctx.globalCompositeOperation = l.b;
      ctx.drawImage(l.img, l.x, l.y);
    });

    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = "source-over";
  }

  fileInput.onchange = async e => {
    for (const f of e.target.files) {
      const img = new Image();
      img.src = URL.createObjectURL(f);
      await img.decode();
      layers.push({ img, x: 0, y: 0, o: 1, b: "screen" });
    }
    hud.textContent = layers.length + " layers loaded";
    draw();
  };

  document.getElementById("exportBtn").onclick = () => {
    if (!layers.length) return;
    const base = layers[0].img;
    const out = document.createElement("canvas");
    out.width = base.width;
    out.height = base.height;
    const octx = out.getContext("2d");

    octx.fillStyle = "#000";
    octx.fillRect(0,0,out.width,out.height);

    layers.forEach(l=>{
      octx.globalAlpha = l.o;
      octx.globalCompositeOperation = l.b;
      octx.drawImage(l.img,l.x,l.y);
    });

    const a = document.createElement("a");
    a.href = out.toDataURL("image/png");
    a.download = "astro_stack.png";
    a.click();
  };
})();
</script>
</body>
</html>
