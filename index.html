<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Astro Stack (Layer Aligner)</title>

<style>
:root { --bg:#0b1020; --panel:#111a33; --muted:#9fb2ff; --text:#e8ecff; --accent:#6aa9ff; }
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: radial-gradient(1200px 600px at 30% 10%, #16224a 0%, var(--bg) 60%);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

header {
  padding: 14px 16px;
  display: flex;
  gap: 12px;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,.08);
  background: rgba(8,12,26,.6);
  backdrop-filter: blur(8px);
}

header h1 {
  font-size: 14px;
  letter-spacing: .6px;
  text-transform: uppercase;
  margin: 0;
  color: #cfe0ff;
}

.wrap {
  display: grid;
  grid-template-columns: 360px 1fr;
  height: calc(100vh - 52px);
}

.panel {
  background: linear-gradient(180deg, rgba(17,26,51,.9), rgba(12,18,35,.95));
  border-right: 1px solid rgba(255,255,255,.08);
  overflow: auto;
  padding: 14px;
}

.panel .block {
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 12px;
}

.row { display:flex; gap:10px; flex-wrap:wrap; }
.muted { color: rgba(232,236,255,.75); font-size: 12px; }

.btn {
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
}

.btn.primary {
  background: rgba(106,169,255,.14);
  border-color: rgba(106,169,255,.5);
}

input[type=file]{display:none}

.stage {
  position: relative;
  overflow: hidden;
  background: radial-gradient(900px 500px at 50% 40%, rgba(140,190,255,.10), rgba(0,0,0,0) 55%);
}

canvas {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}

.hud {
  position:absolute;
  left:14px;
  bottom:14px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(8,12,26,.55);
  border:1px solid rgba(255,255,255,.1);
  font-size:12px;
}

.ctl {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

label { font-size:11px; opacity:.8 }

@media (max-width:900px){
  .wrap { grid-template-columns:1fr; grid-template-rows:1fr auto; }
  .panel { max-height:45vh; border-right:none; border-top:1px solid rgba(255,255,255,.1); }
}
</style>
</head>

<body>
<header>
  <h1>Astro Stack â€” Layer Aligner</h1>
  <div class="muted">Load frames, align, blend, enhance, export.</div>
</header>

<div class="wrap">
<aside class="panel">

<div class="block">
  <div class="row">
    <label class="btn primary" for="fileInput">Load Images</label>
    <input id="fileInput" type="file" multiple accept="image/*">
    <button class="btn" id="exportBtn">Export PNG</button>
  </div>
</div>

<div class="block">
  <div class="ctl">
    <div>
      <label>Gamma Stretch</label>
      <input type="range" id="gamma" min="0.4" max="1.2" step="0.01" value="0.75">
    </div>
    <div>
      <label>Background Extraction</label>
      <input type="range" id="bgExt" min="0" max="1" step="0.01" value="0.45">
    </div>
    <div>
      <label>Noise Reduction</label>
      <input type="range" id="nr" min="0" max="1" step="0.01" value="0.3">
    </div>
  </div>
</div>

</aside>

<main class="stage" id="stage">
  <canvas id="c"></canvas>
  <div class="hud" id="hud">No images loaded</div>
</main>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const stage = document.getElementById("stage");
const fileInput = document.getElementById("fileInput");
const hud = document.getElementById("hud");

const astro = {
  gamma: 0.75,
  bgExtract: 0.45,
  noise: 0.3
};

let layers = [];

function resize(){
  const dpr = devicePixelRatio || 1;
  canvas.width = stage.clientWidth * dpr;
  canvas.height = stage.clientHeight * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  render();
}
window.addEventListener("resize", resize);
resize();

fileInput.onchange = async e => {
  for(const f of e.target.files){
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await img.decode();
    layers.push(img);
  }
  hud.textContent = layers.length + " images loaded";
  render();
};

document.getElementById("gamma").oninput = e => { astro.gamma = +e.target.value; render(); };
document.getElementById("bgExt").oninput = e => { astro.bgExtract = +e.target.value; render(); };
document.getElementById("nr").oninput = e => { astro.noise = +e.target.value; render(); };

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  layers.forEach(img=>{
    ctx.globalAlpha = 1 / layers.length;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  });

  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = imgData.data;

  // Background extraction
  let samples=[];
  for(let i=0;i<d.length;i+=16){
    samples.push((d[i]+d[i+1]+d[i+2])/3);
  }
  samples.sort((a,b)=>a-b);
  const bg = samples[Math.floor(samples.length/2)] * astro.bgExtract;

  for(let i=0;i<d.length;i+=4){
    d[i]   = Math.max(0, d[i]-bg);
    d[i+1] = Math.max(0, d[i+1]-bg);
    d[i+2] = Math.max(0, d[i+2]-bg);

    d[i]   = 255 * Math.pow(d[i]/255, astro.gamma);
    d[i+1] = 255 * Math.pow(d[i+1]/255, astro.gamma);
    d[i+2] = 255 * Math.pow(d[i+2]/255, astro.gamma);
  }

  // Noise reduction
  if(astro.noise>0){
    const copy = new Uint8ClampedArray(d);
    const r = 1 + Math.floor(astro.noise*2);
    const w = canvas.width;
    const h = canvas.height;

    for(let y=r;y<h-r;y++){
      for(let x=r;x<w-r;x++){
        let i=(y*w+x)*4;
        let s=[0,0,0],c=0;
        for(let dy=-r;dy<=r;dy++){
          for(let dx=-r;dx<=r;dx++){
            let j=((y+dy)*w+(x+dx))*4;
            s[0]+=copy[j]; s[1]+=copy[j+1]; s[2]+=copy[j+2];
            c++;
          }
        }
        d[i]=d[i]*(1-astro.noise)+(s[0]/c)*astro.noise;
        d[i+1]=d[i+1]*(1-astro.noise)+(s[1]/c)*astro.noise;
        d[i+2]=d[i+2]*(1-astro.noise)+(s[2]/c)*astro.noise;
      }
    }
  }

  ctx.putImageData(imgData,0,0);
}

document.getElementById("exportBtn").onclick = ()=>{
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="astro_stack.png";
  a.click();
};
</script>
</body>
</html>
